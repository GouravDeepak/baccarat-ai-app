<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Baccarat Rolling AI Predictor</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f4f7fb; color: #333; margin: 0; padding: 40px 20px; }
        .container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); max-width: 800px; margin: auto; }
        h1 { text-align: center; color: #0d6efd; margin-bottom: 30px; }
        .hand-entry { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; align-items: center; margin-bottom: 15px; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; }
        label { font-weight: 500; font-size: 0.9em; }
        input, select { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; }
        .btn { padding: 12px; font-size: 16px; font-weight: 600; border: none; border-radius: 8px; color: white; cursor: pointer; background-color: #198754; width: 100%; margin-top: 20px; }
        .btn:hover { background-color: #157347; }
        .btn:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        .result-box { background-color: #e9ecef; padding: 15px; border-radius: 8px; margin-top: 15px; font-size: 15px; min-height: 50px; white-space: pre-wrap; font-family: 'Courier New', Courier, monospace; }
        .error { color: #dc3545; font-weight: 600; }
        #next-hand-section { background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 30px; border: 2px dashed #0d6efd; }
        .hidden { display: none; }
    </style>
</head>
<body>
<div class="container">
    <h1>Baccarat Rolling AI Predictor</h1>

    <!-- Section 1: Initial 10 Hands -->
    <fieldset id="initial-sequence-section">
        <legend>Step 1: Prime the AI with the Last 10 Hands</legend>
        <div id="initial-sequence-form">
            <!-- Input fields will be generated by JavaScript -->
        </div>
        <button id="predict-initial-btn" class="btn" onclick="predictInitial()">Get First Prediction</button>
    </fieldset>

    <!-- Section 2: Rolling Prediction (Initially hidden) -->
    <fieldset id="next-hand-section" class="hidden">
        <legend>Step 2: Add Next Hand & Predict</legend>
        <div id="next-hand-form">
            <!-- Single hand input form will be generated here -->
        </div>
        <button id="predict-next-btn" class="btn" onclick="predictNext()">Add Hand & Predict Next</button>
    </fieldset>
    
    <div id="result" class="result-box">Fill out the form to get a prediction.</div>
</div>

<script>
    const initialFormContainer = document.getElementById('initial-sequence-form');
    const nextHandFormContainer = document.getElementById('next-hand-form');
    const resultDiv = document.getElementById('result');
    const sequenceLength = 10;
    let currentSequence = []; // This will store our rolling window of 10 hands

    // --- Generate the initial 10 input rows ---
    function generateInitialForm() {
        let html = '';
        for (let i = 0; i < sequenceLength; i++) {
            html += `
                <div class="hand-entry" id="hand-${i}">
                    <div>
                        <label for="p_total_${i}">Hand ${i+1} P Total:</label>
                        <input type="number" id="p_total_${i}" min="0" max="9" required>
                    </div>
                    <div>
                        <label for="b_total_${i}">B Total:</label>
                        <input type="number" id="b_total_${i}" min="0" max="9" required>
                    </div>
                    <div>
                        <label for="winner_${i}">Winner:</label>
                        <select id="winner_${i}" required>
                            <option value="Player">Player</option>
                            <option value="Banker">Banker</option>
                            <option value="Tie">Tie</option>
                        </select>
                    </div>
                    <div>
                        <label for="natural_${i}">Natural?</label>
                        <input type="checkbox" id="natural_${i}" style="width: auto;">
                    </div>
                </div>
            `;
        }
        initialFormContainer.innerHTML = html;
    }

    // --- Generate the single row form for the next hand ---
    function generateNextHandForm(handNumber) {
        nextHandFormContainer.innerHTML = `
            <div class="hand-entry" id="next-hand">
                <div>
                    <label for="p_total_next">Hand ${handNumber} P Total:</label>
                    <input type="number" id="p_total_next" min="0" max="9" required>
                </div>
                <div>
                    <label for="b_total_next">B Total:</label>
                    <input type="number" id="b_total_next" min="0" max="9" required>
                </div>
                <div>
                    <label for="winner_next">Winner:</label>
                    <select id="winner_next" required>
                        <option value="Player">Player</option>
                        <option value="Banker">Banker</option>
                        <option value="Tie">Tie</option>
                    </select>
                </div>
                <div>
                    <label for="natural_next">Natural?</label>
                    <input type="checkbox" id="natural_next" style="width: auto;">
                </div>
            </div>
        `;
    }

    // --- Collect data from a form row ---
    function getHandData(idPrefix) {
        const player_total = document.getElementById(`p_total_${idPrefix}`).value;
        const banker_total = document.getElementById(`b_total_${idPrefix}`).value;
        const winner = document.getElementById(`winner_${idPrefix}`).value;
        const natural_win = document.getElementById(`natural_${idPrefix}`).checked;

        if (player_total === '' || banker_total === '') {
            resultDiv.innerHTML = '<span class="error">Error: Please fill out all total fields.</span>';
            return null;
        }
        return { player_total, banker_total, winner, natural_win };
    }

    // --- Function for the first prediction ---
    async function predictInitial() {
        const initialSequence = [];
        for (let i = 0; i < sequenceLength; i++) {
            const handData = getHandData(i);
            if (!handData) return; // Stop if any hand is incomplete
            initialSequence.push(handData);
        }
        
        currentSequence = initialSequence;
        await makePrediction(currentSequence, 11);

        // Transition the UI
        document.getElementById('initial-sequence-section').classList.add('hidden');
        document.getElementById('next-hand-section').classList.remove('hidden');
        generateNextHandForm(11);
    }

    // --- Function for all subsequent predictions ---
    async function predictNext() {
        const nextHandData = getHandData('next');
        if (!nextHandData) return;

        // This is the "rolling window" logic
        currentSequence.shift(); // 1. Remove the oldest hand
        currentSequence.push(nextHandData); // 2. Add the newest hand

        const nextHandNumber = currentSequence.length + 1;
        await makePrediction(currentSequence, nextHandNumber);
        
        // Update the form for the next input
        generateNextHandForm(nextHandNumber);
        // Clear the form fields for the user
        document.getElementById('next-hand-form').querySelector('form, div').reset();
    }
    
    // --- Central function to call the API ---
    async function makePrediction(sequence, handNumberToPredict) {
        resultDiv.textContent = `Analyzing for Hand #${handNumberToPredict}...`;
        
        try {
            const response = await fetch('/predict_rich_sequence', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sequence: sequence })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Server error');
            resultDiv.textContent = `--- Prediction for Hand #${handNumberToPredict} ---\n\n`;
            resultDiv.textContent += `Prediction: ${data.prediction}\nConfidence: ${data.confidence}\nBased On: ${data.based_on}`;
        } catch (e) {
            resultDiv.innerHTML = `<span class="error">Request failed: ${e.message}</span>`;
        }
    }

    // --- Initialize the Page ---
    generateInitialForm();

    // A small fix to clear the next-hand form after prediction
    document.getElementById('predict-next-btn').addEventListener('click', () => {
        const form = document.getElementById('next-hand-form').querySelector('.hand-entry');
        if(form) {
            form.querySelectorAll('input[type=number]').forEach(input => input.value = '');
            form.querySelector('input[type=checkbox]').checked = false;
        }
    });

</script>
</body>
</html>